@(lists: List[cielago.models.ListInfo], form: Form[cielago.controllers.TrackRequest], dispatchReport: cielago.models.DispatchReport, messageReports: cielago.models.Paginated[cielago.models.MessageReport])

@import java.util.Locale
@import java.text.SimpleDateFormat

@import cielago.controllers.Main

@layout("Suivi consommation", Some("stylesheets/track.min.css"), Some("js/track.js")) { lang =>
@trackInner(lang, form, dispatchReport) { (locale, jsDatePat, uiDateFmt, startDate, endDate, pageCount) =>

<div class="row-fluid well" id="track-criterias">
  @helper.form(action = cielago.controllers.routes.Main.handleForm, 'id -> "trackForm", 'class -> "form-horizontal") {
  @defining(helper.FieldConstructor(field.f)) { implicit c =>

    <fieldset>
      <legend>Critères de suivi</legend>

      <div class="control-group">
        <label class="control-label" for="mailinglist">Compte (liste)</label>
        <div class="controls">
          @helper.select(field = form("listId"), 
            options = ("","") :: lists.map{li=>(li.listId,li.accountName)})
        </div>

        @helper.input(form("currentPage")) { (id, name, value, args) =>
          <input type="hidden" id="currentPage" 
                 name="currentPage" value="@value" />
          <input type="hidden" name="lang" value="@lang" />
        }

        <label class="control-label" for="startDate">Période</label>
        <div class="controls" id="period">
          @helper.input(form("startDate")) { (id, name, value, args) =>
            @defining(startDate match {
              case None => Map('value -> "")
              case Some(d) => Map('value -> uiDateFmt.format(d))
            }) { attrs =>
            <input type="date" id="startDate" name="start" class="datepicker" 
                   data-date-format="@jsDatePat" 
                   @toHtmlArgs(attrs) />
            }

            <input type="hidden" id="startDateField" 
                   name="startDate" value="@value" />
          }

          <label for="endDate">au</label>

          @helper.input(form("endDate")) { (id, name, value, args) =>
            @defining(endDate match {
              case None => Map('disabled -> "disabled", 'value -> "")
              case Some(d) => Map('value -> uiDateFmt.format(d))
            }) { attrs =>
            <input type="date" id="endDate" name="end" class="datepicker" 
                   data-date-format="@jsDatePat"
                   @toHtmlArgs(attrs) />
            }

            <input type="hidden" id="endDateField" 
                   name="endDate" value="@value" />

          }
        </div>

        <div class="btn-group">
          <button class="btn">Rechercher</button>
        </div>
      </div>  
    </fieldset>
  }<!-- end of FieldConstructor -->
  }<!-- end of form -->
</div>

<div class="page-header">
  <h1>
    Suivi des messages

    <span class="label label-info">
      @if(dispatchReport.recipients <= 1) {
        @dispatchReport.recipients envoi
      } else {
        @dispatchReport.recipients envois
      }
    </span>

    <span class="label" style="margin-left: .5em">
      @if(dispatchReport.messages <= 1) {
        @dispatchReport.messages message
      } else {
        @dispatchReport.messages messages
      }
    </span>
  </h1>

  <form name="paginationForm" action="#">
    <div class="btn-group" id="pagination">
      @defining(form.value match {
        case None => 0
        case Some(tr) => tr.currentPage
      }) { currentPage =>
        @for(pi <- 0L until pageCount) {
          @if(pi == currentPage) {
            <button class="btn btn-inverse" 
                    disabled="disabled" value="@pi">@{pi+1}</button>
          } else {
            <button class="btn" value="@pi">@{pi+1}</button>
          }
        }
      }
    </div>
  </form>
</div>

<table class="table" id="messageReports" data-form="trackForm">
  <thead>
    <tr>
      <th id="sendTime" class="date sorting">Date</th>
      <th id="listId" class="list sorting">Liste</th>
      <th id="recipientCount" class="recipientCount">Destinataires</th>
      <th id="subject" class="subject">Sujet</th>
    </tr>
  </thead>
  <tbody>
    @for(mr <- messageReports.value) {
    <tr>
      <td>@uiDateFmt.format(mr.sendTime)</td>
      <td>@mr.list.accountName</td>
      <td class="recipientCount">@mr.recipientCount</td>
      <td>@mr.subject</td>
    </tr>
    }
  </tbody>
</table>

<script type="text/javascript">
@messageReports.pagination.map { p => 
@defining(p.order.foldLeft("{}") { (str, c) =>
  str match {
    case "{}" => "{'" + c.column + "':'" + c.direction.code + "'}"
    case s => "{'" + c.column + "':'" + c.direction.code + "'," + s.substring(1)
  }
}) { clauses =>
var _s = {clauses: @clauses, columns:{}}
}
}</script>

}
}
